# Obsidian LLM Plugin - 監査および改善レポート

**日付:** 2026-02-15
**ステータス:** 監査完了・修正プラン策定済
**対象:** セキュリティ（最優先）、信頼性、仕様の充足度

---

## 1. セキュリティ監査結果と対応策

### [極めて重要] APIキー平文保存機能の廃止 (#19)
- **問題:** `plaintext` モードが存在し、APIキーが暗号化されずに `data.json` に保存される。同期設定によっては外部に流出する致命的なリスクがある。
- **解決策:** **平文保存機能の完全削除と、既存キーの強制移行。**
- **対応例:**
    - `SecurityLevel` 型から `plaintext` を削除。
    - プラグイン起動時に `data.json` 内の `plaintextKeys` をチェックし、存在すれば `secretstorage` または `webcrypto` へ強制移行。
    - **移行完了後、`data.json` から `plaintextKeys` フィールドを物理的に削除する。**

---

## 2. バグおよび技術的信頼性への対応策

### [最高優先] モバイルキーボード表示時の入力欄隠れ問題 (#12, #13, #22)
- **問題:** iOS等のモバイル環境でキーボードが表示された際、`height: 100%` 設定では入力欄がキーボードの背後に隠れてしまう。
- **解決策:** **Visual Viewport API を用いた動的な高さ制御。**
- **設計方針:**
    - `window.visualViewport` の `resize` イベントを監視し、可視領域の高さをCSS変数 `--llm-viewport-height` に反映する。
    - メインコンテナの `height` をこの変数に同期させ、キーボード出現時にコンテナ自体を縮小させることで、入力欄を常にキーボード直上に維持する。

### [中] Gemini SSEパースの堅牢化 (#20)
- **問題:** Gemini固有のSSEフォーマット（`alt=sse`）に対するパースが不十分。
- **解決策:** **ステートフルなバッファリングの実装。**
- **対応例:**
    - JSONが分割されて届いた場合でも、完全に揃うまでバッファリングしてパースを継続するロジックの導入。

### [中] 不完全なタグの露出防止 (#7)
- **問題:** 生成中の `<vault_write>` 等のタグがUIにそのまま表示される。
- **解決策:** **生成中コンテンツの動的フィルタリング（遮蔽）。**

### [低] 差分計算によるUIブロックの解消 (#21)
- **問題:** 長いノートの差分計算時にメインスレッドが止まる。
- **解決策:** **非同期処理への移行。**

---

## 3. 仕様および機能 of 改善案

### [重要] モデルリストの動的取得 (#9)
- **問題:** `constants.ts` にモデルがハードコードされており、新モデル対応にプラグイン更新が必要。
- **解決策:** **APIエンドポイントからのモデル取得機能。**

---

## 4. 実行ロードマップ（修正優先順位）

### **フェーズ 1: セキュリティの抜本的強化（最優先）**
1.  **平文保存機能の完全削除** (#19)、および移行・クリーンアップロジックの実装。

### **フェーズ 2: 通信とUIの信頼性向上**
1.  **モバイルキーボード隠れ問題の解消** (#12, #22)。
2.  Gemini SSEパースの堅牢化 (#20)。
3.  生成中タグの動的隠蔽フィルター (#7)。
4.  差分計算の非同期化 (#21)。

---

## LLMエージェントへの技術的指示
- **モバイルUI修正 (#12):** 
    - `src/ui/responsive.ts` に `setupMobileViewportHandler(containerEl: HTMLElement)` を実装すること。
    - `window.visualViewport.addEventListener("resize", ...)` で `containerEl.style.setProperty("--llm-viewport-height", vv.height + "px")` を実行。
    - `styles.css` の `.llm-assistant-view` の `height` を `var(--llm-viewport-height, 100%)` に変更すること。
- **平文保存の完全撤去:** 移行後に古いキーが残らないよう、`saveData` を呼び出して設定からフィールドを削除すること。
- **型安全:** `ChatView` における不明なメソッド呼び出し（`as any`）を解消し、インターフェースを定義すること。
